<!doctype html><html><head><title>Iron.io and Lumen</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/assets/css/bootstrap.min.css><link rel=stylesheet href=/assets/css/layouts/main.css><link rel=stylesheet href=/assets/css/style.css><link rel=stylesheet href=/assets/css/navigators/navbar.css><link href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css><link rel=icon type=image/png href=/images/site/favicon.jpg><link rel=stylesheet href=/assets/css/style.css><meta name=description content="Iron.io and Lumen"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css><link rel=stylesheet href=/assets/css/layouts/single.css><link rel=stylesheet href=/assets/css/navigators/sidebar.css><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-39925227-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/><img src=/images/site/main-logo.jpg>Alfred Nutile</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"></ul></div></div><img src=/images/site/main-logo.jpg class=d-none id=main-logo>
<img src=/images/site/inverted-logo.jpg class=d-none id=inverted-logo></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><input type=text placeholder=Search data-search id=search-box><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts data-filter=all>Posts</a></li><div class=subtree><li><a href=/posts/267/>Windows Dev Box Try 3 2020</a></li><li><a href=/posts/266/>Using Python Lambda behind and ALB</a></li><li><a href=/posts/265/>Suggestions Around Building a Good Development Team in Parallel to Building a Good Product</a></li><li><a href=/posts/264/>Lambda Tips</a></li><li><a href=/posts/263/>Mocking in Python</a></li><li><a href=/posts/262/>PHP Xdebug Visual Code</a></li><li><a href=/posts/261/>Cognito and OAuth</a></li><li><a href=/posts/260/>PHPUnit CodeCoverage</a></li><li><a href=/posts/259/>Deploying Fargate</a></li><li><a href=/posts/258/>How to Troubleshoot and Issue</a></li><li><a href=/posts/257/>Bitbucket Pipeline</a></li><li><a href=/posts/256/>JSONEditor, Vue and Vuex</a></li><li><a href=/posts/255/>Laravel Filter Scope on a Model</a></li><li><a href=/posts/254/>Query Strings, Vue and Bootstrap Active Tab</a></li><li><a href=/posts/253/>Valet Laravel 7.1 and 7.2</a></li><li><a href=/posts/252/>Python3 Fixtures</a></li><li><a href=/posts/251/>PHPStan Setup</a></li><li><a href=/posts/250/>Vuex External File</a></li><li><a href=/posts/249/>Simple API_Token Auth for VueJS Components and Laravel</a></li><li><a href=/posts/248/>Dusk Screenshots to S3 of Failing tests</a></li><li><a href=/posts/247/>Windows Dev Box Try 2 2018</a></li><li><a href=/posts/246/>Laravel Queue Restart and 'Why are my changes not showing up'</a></li><li><a href=/posts/245/>Lambda and Github Webhooks</a></li><li><a href=/posts/244/>Query Strings and VueJS</a></li><li><a href=/posts/243/>Debugging AWS SAM</a></li><li><a href=/posts/242/>wip Fargate and Laravel</a></li><li><a href=/posts/241/>Getting Started with Orchestra Testbench for Laravel Package Development</a></li><li><a href=/posts/240/>GroupBy not Sorting by latest</a></li><li><a href=/posts/239/>BrowserSync and Laravel</a></li><li><a href=/posts/238/>Troubleshoot Laravel Socialite and Github login</a></li><li><a href=/posts/237/>Wrapping Libraries in Services JS</a></li><li><a href=/posts/236/>Passing from Blade to VueJs</a></li><li><a href=/posts/235/>Laravel and AWS Rekognition</a></li><li><a href=/posts/234/>Docker Laravel and Cron</a></li><li><a href=/posts/233/>Pusher and Laravel Updates</a></li><li><a href=/posts/232/>Dusk and Production (with Dusk disabled)</a></li><li><a href=/posts/231/>Testing Laravel API, Spark with Authentication</a></li><li><a href=/posts/230/>Example of Making Documentation in Markdown with PDF Output</a></li><li><a href=/posts/229/>Serverless Python and Example App WIP</a></li><li><a href=/posts/228/>VueJS Transition Helper</a></li><li><a href=/posts/227/>Laravel Asset Notes WIP</a></li><li><a href=/posts/226/>PostMark SMTP for sending Notifications and Password Resets</a></li><li><a href=/posts/225/>Dusk Notes</a></li><li><a href=/posts/224/>Continuous Delivery in a NutShell</a></li><li><a href=/posts/223/>Laravel Shift and Your Day Job</a></li><li><a href=/posts/222/>Wrapping JSONEditor in Vue as Well as Laravel Blade</a></li><li><a href=/posts/221/>Laravel, Dusk and Valet</a></li><li><a href=/posts/220/>WIP AWS Batch and Workers with Laravel</a></li><li><a href=/posts/219/>Mocking Models OutSide of Laravel</a></li><li><a href=/posts/218/>Versions and Branching a Library</a></li><li><a href=/posts/217/>Serverless and Custom Tags for Resources</a></li><li><a href=/posts/215/>Setting Up My Mac</a></li><li><a href=/posts/214/>Serverless, AWS API Gateway and Authentication</a></li><li><a href=/posts/213/>IronFunctions and PHP</a></li><li><a href=/posts/212/>Testing a trait with PHPUnit</a></li><li><a href=/posts/211/>Machine to Machine Laravel Passport</a></li><li><a href=/posts/210/>Meetings and Cross TimeZone Teams</a></li><li><a href=/posts/209/>Dusk and Homestead</a></li><li><a href=/posts/208/>Simple Slack Trait Get Request and return Response</a></li><li><a href=/posts/207/>We Code in the Context of our Quoting</a></li><li><a href=/posts/206/>Instantiate Request for Testing</a></li><li><a href=/posts/205/>Load Testing With Behat</a></li><li><a href=/posts/204/>Example Job Format for Queue</a></li><li><a href=/posts/203/>LarScanner simple foundation for building a good Laravel Security Scanner</a></li><li><a href=/posts/202/>Super Simple Sending Messages to Slack from Laravel</a></li><li><a href=/posts/201/>Pusher and PHP 'Error Failed to connect to Pusher'</a></li><li><a href=/posts/200/>Model Boot Events</a></li><li><a href=/posts/199/>Queue onConnection</a></li><li><a href=/posts/198/>Guzzle 5 or 6 or ????</a></li><li><a href=/posts/197/>Chrome update equals Behat Fail</a></li><li><a href=/posts/196/>Laravel and Casting 'JSON_UNESCAPED_UNICODE' Data</a></li><li><a href=/posts/195/>Laravel 5.x Cookbook Chat Area</a></li><li><a href=/posts/194/>Throttle Password Reset</a></li><li><a href=/posts/193/>Laravel Throttle Feature using IP address as Key</a></li><li><a href=/posts/192/>Troubleshooting a Failed Build with Codeship and SauceLabs</a></li><li><a href=/posts/191/>Amazon Machine Learning</a></li><li><a href=/posts/190/>Mockery Behat and Laravel</a></li><li><a href=/posts/189/>Adding Basic Auth to Forge</a></li><li><a href=/posts/188/>Uploading Images in Behat both at Domain Level and UI Level</a></li><li><a href=/posts/187/>Behat Laravel Domain Testing Inside Out</a></li><li><a href=/posts/186/>Keeping a Controller Method Simple</a></li><li><a href=/posts/185/>Example of Mixing it up Behat BDD and PHPUnit</a></li><li><a href=/posts/184/>Homestead and Auto Setup Hosts File</a></li><li><a href=/posts/183/>API Token Based Access Laravel 5.1 (Yet another article on this)</a></li><li><a href=/posts/182/>Contract Testing</a></li><li><a href=/posts/181/>Getting Going Quickly Windows, Behat and Selenium</a></li><li><a href=/posts/180/>AWS, S3 Storage and limited Visibility</a></li><li><a href=/posts/179/>Behat and Uploading Files to a Form Even on Remote Selenium2 Servers</a></li><li><a href=/posts/178/>Laravel, PHPUnit, Require_Once on Routes</a></li><li><a href=/posts/177/>Remote Behat Testing with Laravel</a></li><li><a href=/posts/176/>CMS or NOT CMS</a></li><li><a href=/posts/175/>Feature Flags In Laravel</a></li><li><a href=/posts/174/>Install Webdriver to get testing with Behat and Javascript</a></li><li><a href=/posts/173/>Slack Custom Commands and Laravel to Make an American to British Translater</a></li><li><a href=/posts/172/>Then Benefits of Building a Clickable POC as a Developer</a></li><li><a href=/posts/171/>Put It All Into Version Control Even Composer!</a></li><li><a href=/posts/170/>Why Side Projects are Good For Me</a></li><li><a href=/posts/169/>Do I Really Need This Route Anymore?</a></li><li><a href=/posts/168/>Logout User After Inactivity Laravel and Milddleware</a></li><li><a href=/posts/167/>CentOS or RedHat and Laravel</a></li><li><a href=/posts/166/>Quick Tip Forcing More Complex Passwords in Laravel</a></li><li><a href=/posts/165/>Image Uploads, Laravel, Angular and Flow.js</a></li><li><a href=/posts/164/>Simple Example of Making Code Easier to Read</a></li><li><a href=/posts/163/>Spark Setup Issue</a></li><li><a href=/posts/162/>Adding Expose IDS to Laravel MiddleWare</a></li><li><a href=/posts/161/>Note To Self: A VirtualBox machine with the name 'homestead' already exists.</a></li><li><a href=/posts/160/>Laravel and Angular Widgets e.g. Non SPA (Single Page Application) Pattern</a></li><li><a href=/posts/159/>Laravel 5.1 and Oauth</a></li><li><a href=/posts/158/>Talking to the Methods Not the Properties</a></li><li><a href=/posts/157/>Using your project docs inside the application</a></li><li><a href=/posts/156/>Behat for Product Owners</a></li><li><a href=/posts/155/>HasMany Through a Many to Many</a></li><li><a href=/posts/154/>Adding RSS to Your Site</a></li><li><a href=/posts/153/>Bower and Elixir</a></li><li><a href=/posts/152/>Quick way to Request Json from Angular and return from Laravel</a></li><li><a href=/posts/151/>Laravel 5.1 Behat and Codeship</a></li><li><a href=/posts/150/>Conventions to Help Minimize your ENV File</a></li><li><a href=/posts/149/>Start to end Billing using Stripe, Cashier and Laravel 5.1</a></li><li><a href=/posts/148/>Codeship and Laravel for Continuous Integration</a></li><li><a href=/posts/147/>Logging in Iron.io Workers</a></li><li><a href=/posts/146/>Writing Commands and Scheduling in Laravel 5.1</a></li><li><a href=/posts/145/>Easily Create Fixture Data from Remote Services and Refresh Mock Data</a></li><li><a href=/posts/144/>Adding Cache to your Laravel Site</a></li><li><a class=active href=/posts/143/>Iron.io and Lumen</a></li><li><a href=/posts/142/>Quick way to mock data for Behat in Laravel</a></li><li><a href=/posts/141/>Code for making a Shortcut tool for your App</a></li><li><a href=/posts/140/>Using Faker and ENV vars with Behat</a></li><li><a href=/posts/139/>Using a BurnDown Chart to Pace Yourself</a></li><li><a href=/posts/138/>Behat and PhantomJs</a></li><li><a href=/posts/137/>PHP Error: Maximum function nesting level of '100' reached, aborting Behat</a></li><li><a href=/posts/136/>Iron.io Laravel and Workers, Microservices</a></li><li><a href=/posts/135/>Multi Domain Nginx Redirect</a></li><li><a href=/posts/134/>Sending Dates to Angular from Laravel</a></li><li><a href=/posts/133/>Dealing with Oauth2 Server and Laravel for both a local app login and for remote apps using Lucadegasperi/oauth2-server-laravel</a></li><li><a href=/posts/132/>Simple Look at Laravel Events</a></li><li><a href=/posts/131/>Laravel-Flysystem and Creating Time Limited Public Urls on S3</a></li><li><a href=/posts/130/>Laravel Behat and Selenium</a></li><li><a href=/posts/129/>Linux, Behat and installing ChromeDriver</a></li><li><a href=/posts/128/>Sqlite and Laravel</a></li><li><a href=/posts/127/>Timing PHPUnit Tests</a></li><li><a href=/posts/126/>Reusable UI/API CRUD Laravel and Angular</a></li><li><a href=/posts/124/>Laravel Blade and Angular brackets</a></li><li><a href=/posts/123/>Angular History Based BreadCrumbs</a></li><li><a href=/posts/122/>Embed Template Data in View (Angular, Laravel)</a></li><li><a href=/posts/121/>Quick fixture data and mocking external APIs</a></li><li><a href=/posts/120/>Mocking Queue Service for faster Behat Testing</a></li><li><a href=/posts/119/>Redirecting back to original Angular.js destination from Laravel Auth</a></li><li><a href=/posts/118/>Docker, MailCatcher and Laravel</a></li><li><a href=/posts/117/>PHP quick fixture data for phpunit testing</a></li><li><a href=/posts/116/>Nginx force SSL</a></li><li><a href=/posts/115/>Moving Forge Deploy Script to Envoy</a></li><li><a href=/posts/114/>Laravel and Angular Time/Date Display</a></li><li><a href=/posts/113/>Laravel 4.2 and Dotenv to set environment</a></li><li><a href=/posts/112/>Speeding up PHPunit tests and Behat in Laravel for Database refreshes</a></li><li><a href=/posts/111/>Angular Pusher Factory to Centralize Code (also using Laravel to set constants and properties)</a></li><li><a href=/posts/110/>CSRF Tokens and Angular.js</a></li><li><a href=/posts/109/>Temporary Auth Updates L5</a></li><li><a href=/posts/108/>Chrome and Behat</a></li><li><a href=/posts/107/>Design Guide - Controllers, Services and IOC</a></li><li><a href=/posts/106/>Multi Threaded Queue Processing</a></li><li><a href=/posts/105/>Team Style Guides and Mind Set</a></li><li><a href=/posts/104/>Sorting related models in Laravel</a></li><li><a href=/posts/103/>Behat for testing RESTful APIs</a></li><li><a href=/posts/102/>Boris REPL and you Applicatoin (Silex in this case)</a></li><li><a href=/posts/101/>SSL and Homestead</a></li><li><a href=/posts/100/>Drush and Homestead Vagrant Box</a></li><li><a href=/posts/99/>Polymorphic relationship Laravel</a></li><li><a href=/posts/98/>Quick way to traverse a nested php arrray</a></li><li><a href=/posts/97/>Using VCR for PHP API Testing</a></li><li><a href=/posts/96/>Saucelabs PHP Client</a></li><li><a href=/posts/95/>Many to Many Polymorphic Relations from Laravel to Angular and back</a></li><li><a href=/posts/94/>Laravel Sentry and UUID</a></li><li><a href=/posts/93/>Laravel Homestead and MailCatcher</a></li><li><a href=/posts/92/>Laravel Homestead and Beanstalkd Console</a></li><li><a href=/posts/91/>Restangular and nested responses</a></li><li><a href=/posts/90/>Behat Test more than number of elements</a></li><li><a href=/posts/89/>When you have to use Angular inside of Drupal</a></li><li><a href=/posts/88/>Transforming Output from the Database to the View/REST layer</a></li><li><a href=/posts/87/>Showing nested relationships details</a></li><li><a href=/posts/86/>Simple Laravel CMS Example</a></li><li><a href=/posts/85/>Quick Gulp file to run php-unit tests</a></li><li><a href=/posts/84/>Laravel and non email authentication</a></li><li><a href=/posts/78/>Using Beanstalkd to Schedule the release of a post in Laravel</a></li><li><a href=/posts/77/>Behat Seed Repo</a></li><li><a href=/posts/76/>Using Dot Env files to manage settings</a></li><li><a href=/posts/69/>Using Scopes in Laravel</a></li><li><a href=/posts/68/>Quick way to add text to a hidden ckeditor field</a></li><li><a href=/posts/67/>Github CLI to get Teams and Members of an Org</a></li><li><a href=/posts/66/>Mink Assertions</a></li><li><a href=/posts/65/>Drupal and Composer install or update</a></li><li><a href=/posts/64/>Adding Column using sqlite caused error 'Cannot add a NOT NULL column with default value NULL'</a></li><li><a href=/posts/63/>php artisan migrate:reset not working</a></li><li><a href=/posts/62/>Angular and Scope - or - How not to waste time figuring out why a scope value is not 'working'</a></li><li><a href=/posts/61/>Behat Checkbox</a></li><li><a href=/posts/60/>Adding Markdown Editor to your Blog/CMS</a></li><li><a href=/posts/59/>Running multiple tasks asynchronously with Drush, Drupal and MT</a></li><li><a href=/posts/58/>Building the UI first with Angular, Mocked Data and REST</a></li><li><a href=/posts/57/>Behat Vagrant install and local testing</a></li><li><a href=/posts/56/>GitWrapper Per Page settings KnpLabs / php-github-api</a></li><li><a href=/posts/55/>Angular and Laravel Partials</a></li><li><a href=/posts/54/>Using Github Pages for your help docs</a></li><li><a href=/posts/53/>Twig and Drupal 7</a></li><li><a href=/posts/52/>Drupal Services and Instantiating a Class</a></li><li><a href=/posts/51/>Guard, Laravel and phpunit</a></li><li><a href=/posts/50/>Angular.js, CKEditor, and REST including file uploads</a></li><li><a href=/posts/49/>Saucelabs Timeout</a></li><li><a href=/posts/48/>Angular Drupal and CSRF</a></li><li><a href=/posts/47/>Ng-if and Scope</a></li><li><a href=/posts/46/>Mocking drupal database queries</a></li><li><a href=/posts/45/>Ubuntu 12.04 and PHP 5.4</a></li><li><a href=/posts/44/>Laravel Project Management Site</a></li><li><a href=/posts/43/>Angular Watching a model and it's filters</a></li><li><a href=/posts/42/>Behat Resources</a></li><li><a href=/posts/41/>Nesting Laravel 4 Routes</a></li><li><a href=/posts/40/>Exploring Code and Laravel</a></li><li><a href=/posts/39/>Node.js error</a></li><li><a href=/posts/38/>Behat and bad HTML</a></li><li><a href=/posts/37/>Behat Mink and using Javascript / jQuery to test attributes</a></li><li><a href=/posts/36/>Keep it (functions/methods) small and simple</a></li><li><a href=/posts/35/>PHPSH</a></li><li><a href=/posts/34/>Behat and Drupal episode 1</a></li><li><a href=/posts/33/>Quick Script to update Heroku database</a></li><li><a href=/posts/32/>Bash History</a></li><li><a href=/posts/31/>Drupal FAPI Validation Error</a></li><li><a href=/posts/30/>Heroku in Heroku</a></li><li><a href=/posts/29/>Drush and Features-Export</a></li><li><a href=/posts/28/>Hosting is Dead?</a></li><li><a href=/posts/27/>HerokuApps and Multiple Domains</a></li><li><a href=/posts/26/>Global Redirect module after spaces / purl install does not</a></li><li><a href=/posts/25/>Ruby on Rails with CMS and other fun stuff</a></li><li><a href=/posts/24/>Paperclip and S3 and Ckeditor</a></li><li><a href=/posts/23/>RubyMine and BetterErrors</a></li><li><a href=/posts/22/>Installing mysql2 on a mac</a></li><li><a href=/posts/21/>NDA</a></li><li><a href=/posts/20/>Capistrano for non-rails sites</a></li><li><a href=/posts/19/>Angular Seed Testing Setup</a></li><li><a href=/posts/18/>Angular.js Ticket System</a></li><li><a href=/posts/17/>Paperclip and S3</a></li><li><a href=/posts/16/>Technologies for a Saas</a></li><li><a href=/posts/15/>My first Rails site for the masses.</a></li><li><a href=/posts/14/>Refinery CMS and Twitter Bootstrap</a></li><li><a href=/posts/13/>Vagrant and Laravel</a></li><li><a href=/posts/12/>Questions that may come in handy when interviewing</a></li><li><a href=/posts/11/>Hack For Change Challenge</a></li><li><a href=/posts/10/>Bootstrap Generator Gem Ruby on Rails</a></li><li><a href=/posts/9/>Using headless tests with Mink and Behat</a></li><li><a href=/posts/8/>ActiveAdmin Rails</a></li><li><a href=/posts/7/>Making lists from acts_as_taggable</a></li><li><a href=/posts/6/>Javascript Based Product Viewer</a></li><li><a href=/posts/5/>jQuery Address</a></li><li><a href=/posts/4/>CORS and Laravel</a></li><li><a href=/posts/3/>Great tip on Git and Jenkins to auto deploy</a></li><li><a href=/posts/2/>Going Angular.js</a></li><li><a href=/posts/1/>DrupalCamp Western Mass</a></li><li><a href=/posts/introduction/>Introduction</a></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(https://alnutile.github.io/images/heros/hero-office.png)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/avatar.jpg><h5 class=author-name></h5><p>April 28, 2015</p></div><div class=title><h1>Iron.io and Lumen</h1></div><div class=post-content id=post-content><h1 id=lumen-iron-worker>Lumen Iron Worker</h1><h2 id=what-and-why>What and why</h2><p>A worker is a great way to run tasks as needed taking the load off your applications server and greatly speeding up the process of a task as you can run numerous workers at once.</p><p>A lot of this comes from <a href=http://dev.iron.io/worker/beta/getting_started/>http://dev.iron.io/worker/beta/getting_started/</a> and
<a href=http://dev.iron.io/worker/beta/cli/>http://dev.iron.io/worker/beta/cli/</a> and their examples</p><h2 id=topics-covered>Topics covered</h2><ul><li>Creating a Lumen Worker</li><li>Creating a statically linked binary in the worker</li><li>Testing the worker locally with Docker</li><li>Entering your docker environment</li><li>Design patterns</li></ul><h2 id=install-lumen>Install Lumen</h2><pre><code>composer create-project laravel/lumen --prefer-dist
</code></pre><p>Add to composer.json</p><blockquote><pre><code>  &quot;iron-io/iron_mq&quot;: &quot;~1.5&quot;,
</code></pre></blockquote><pre><code>  &quot;iron-io/iron_worker&quot;: &quot;~1.4&quot;
</code></pre><p>So now it looks like</p><pre><code>    &quot;require&quot;: {
        &quot;laravel/lumen-framework&quot;: &quot;5.0.*&quot;,
        &quot;vlucas/phpdotenv&quot;: &quot;~1.0&quot;,
        &quot;iron-io/iron_mq&quot;: &quot;~1.5&quot;,
        &quot;iron-io/iron_worker&quot;: &quot;~1.4&quot;
    },
</code></pre><h2 id=install-iron-client>Install iron client</h2><p>See their notes here <a href=http://dev.iron.io/worker/beta/cli/>http://dev.iron.io/worker/beta/cli/</a></p><h2 id=install-docker>Install docker</h2><p>On a mac they have great steps here for that <a href=https://docs.docker.com/installation/mac/>https://docs.docker.com/installation/mac/</a></p><h2 id=environment-settings>Environment settings</h2><p>For Lumen we can simply use our typical .env file. For Iron you put your info in the iron.json file in the root of the app (make sure to add this to .gitignore)</p><p>The format is</p><pre><code>{ &quot;token&quot;: &quot;foo&quot;, &quot;project_id&quot;: &quot;bar&quot; }
</code></pre><h2 id=the-worker>The worker</h2><p>Make a folder called workers at the root of your app</p><p>In there place your worker file. In this case <code>ExampleOneWorker</code>. This is what gets called, as you will see soon, when the worker starts. This is what will receive the payload.</p><pre><code>workers/ExampleOneWorker.php
</code></pre><p>Inside of this to start will be</p><pre><code>&lt;?php

require_once __DIR__ . '/libs/bootstrap.php';

$payload = getPayload(true);

fire($payload);

function fire($payload)
{
    try
    {
        $handler = new \App\ExampleOneHandler();
        $handler-&gt;handle($payload);
    }

    catch(\Exception $e)
    {
        $message = sprintf(&quot;Error with worker %s&quot;, $e-&gt;getMessage());
        echo $message;
    }

}
</code></pre><p>For testing reasons and code clarity I do not like to put much code in here. I instantiate a handler class and pass in the payload.</p><p>The getPayload in the helper.php file, provided by an Iron.io example, will get the payload for us.</p><p>There is another folder to make in there called libs and for now it has this file <code>bootstrap.php</code> and <code>helper.php</code> [1] The helper is <a href=https://github.com/alnutile/lumen_worker/blob/master/workers/libs/helper.php>here</a></p><p>With the contents as seen below for bootstrap or <a href=https://github.com/alnutile/lumen_worker/tree/master/workers/libs>visit</a> to get the files.</p><pre><code>&lt;?php
require __DIR__ . '/../../vendor/autoload.php';
$app = require_once __DIR__ . '/../../bootstrap/app.php';
if(!function_exists('getPayload'))
    require_once __DIR__ . '/helper.php';
    
use Illuminate\Encryption\Encrypter;
$app-&gt;boot();

function decryptPayload($payload)
{
    $crypt = new Encrypter(getenv('IRON_ENCRYPTION_KEY'));
    $payload = $crypt-&gt;decrypt($payload);
    return json_decode(json_encode($payload), FALSE);
}
</code></pre><p><code>helper.php</code> I placed a gist here <a href=https://gist.github.com/alnutile/41ee747bb8e1810d19e8>https://gist.github.com/alnutile/41ee747bb8e1810d19e8</a></p><p>Also for this example we will need a <code>payload.json</code> file in the root of our app. More on that shortly, for now put this into the file.</p><pre><code>{
    &quot;foo&quot;: &quot;bar&quot;
}
</code></pre><p>Finally our app folder has the <code>ExampleOneHandler.php</code> file to handle the job.</p><pre><code>&lt;?php

namespace App;


class ExampleOneHandler {

    public function handle($payload)
    {
        echo &quot;This is the Payload&quot;;
        echo print_r($payload, 1);

        
    }
}
</code></pre><p>We will do more shortly.</p><p>Here is the folder/file layout</p><p><img src="https://dl.dropboxusercontent.com/s/c561wmsnv8hl2rm/worker_files.png?dl=0" alt=files></p><h2 id=round-1-exampleonehandler>Round 1 ExampleOneHandler</h2><p>Lets now run this and see what happens.</p><p>Using docker we can run this locally</p><pre><code>docker run --rm -v &quot;$(pwd)&quot;:/worker -w /worker iron/images:php-5.6 sh -c &quot;php /worker/workers/ExampleOneWorker.php -payload payload.json&quot;
</code></pre><p>You just ran, what ideally will be, the exact worker you will run when you upload the code. It will take a moment on the first run. After that it will be super fast.</p><p>Here is my output</p><p><img src="https://dl.dropboxusercontent.com/s/4qkq5e21jl550sg/worker_command.png?dl=0" alt=outputone></p><h3 id=uploading-to-iron>Uploading to Iron</h3><h4 id=bundle>Bundle</h4><p>This is really easy to make a script for by just adding them to an upload_worker.sh file in the root of your app and running that as needed.</p><pre><code>touch ExampleOneWorker.zip
rm ExampleOneWorker.zip
zip -r ExampleOneWorker.zip . -x *.git*
iron worker upload --stack php-5.6 ExampleOneWorker.zip php workers/ExampleOneWorker.php
</code></pre><p>So we are touching the file so there are no errors if it is not there.
Then we rm it
And zip it ignoring .git to keep it slim
and then we upload it with the worker and point to the directory to use.</p><p><strong>Don&rsquo;t run it just yet</strong></p><p>I add my iron.json file to the root of my app as noted above.</p><p>and I make the Project on the Iron HUD</p><p><img src="https://dl.dropboxusercontent.com/s/qq2h0to2epnc0qw/worker_json.png?dl=0" alt=iron></p><p>And then I can run the <code>make_worker.sh</code> I made above</p><p>You should end up with this output</p><p><img src="https://dl.dropboxusercontent.com/s/utb478g6510rssd/worker_iron_upload.png?dl=0" alt=output></p><h4 id=looking-at-the-hud-iron-webui>Looking at the HUD (Iron WebUI)</h4><p>Under Worker and tasks we see</p><p><img src="https://dl.dropboxusercontent.com/s/7d1klwablw037wh/worker_hud_tasks.png?dl=0" alt=worker></p><p>So lets run it from the command line to see it work</p><pre><code>iron worker queue --wait -payload-file payload.json ExampleOneWorker
</code></pre><p>The wait is pretty cool since we can get this output. This is key when doing master slave workers as well.</p><p>You get the same output as before. But it was run on the worker</p><p>Here is the HUD</p><p><img src="https://dl.dropboxusercontent.com/s/bxc1dolij0l2f7w/worker_run_example1.png?dl=0" alt="worker ran"></p><h2 id=round-2-lets-do-something-real>Round 2 Lets do something real</h2><p>So far the payload has not done much but lets use it in this next example.</p><p>As above we make and <code>ExampleTwoWorker.php</code></p><p>Make payload2.json file</p><pre><code>{
    &quot;search_word&quot;: &quot;batman&quot;
}
</code></pre><p>Then we use it to call our <code>ExampleTwoWorkerHandler</code></p><p><strong>warning this is not an example on good php code</strong></p><pre><code>&lt;?php namespace App;


class ExampleTwoHandler {

    protected $search_word;
    protected $result;

    public function handle($payload)
    {
		 $this-&gt;search_word = $payload['search_word'];
        $this-&gt;getImage();
        return $this-&gt;popFirstResult();
    }

    protected function getImage()
    {
        $url = 'http://ajax.googleapis.com/ajax/services/search/images?v=1.0&amp;q=';
        $url .= urlencode(&quot;site:www.thebrickfan.com &quot; . $this-&gt;search_word . &quot; lego&quot;);
        $curl = curl_init();
        curl_setopt($curl, CURLOPT_URL, $url);
        curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
        $data = curl_exec($curl);
        curl_close($curl);
        $result = json_decode($data, true);
        $this-&gt;result = $result;
    }

    protected function popFirstResult()
    {
        $max = count($this-&gt;result['responseData']['results']);
        if($max == 0)
        {
            throw new \Exception(sprintf(&quot;No image found :( for %s&quot;, $this-&gt;search_word));
        }
        else
        {
            $image = $this-&gt;result['responseData']['results'][rand(0, $max - 1)]['url'];
            return file_get_contents($image);
        }
    }

}
</code></pre><p>I test locally</p><pre><code>docker run --rm -v &quot;$(pwd)&quot;:/worker -w /worker iron/images:php-5.6 sh -c &quot;php /worker/workers/ExampleTwoWorker.php -payload payload2.json&quot; &gt; output.png
</code></pre><p>But this time put the output into a file and we get</p><p><img src="https://dl.dropboxusercontent.com/s/kmtuvgzhpzws6xz/worker_lego_one.png?dl=0" alt="lego guys"></p><h3 id=making-a-custom-binary>Making a custom binary</h3><p>Before I get this to iron lets make it more useful since I will lose that output.png file on the worker. Some workers we have would convert that into a base64 blob and send that back in a callback.</p><p>One enter into docker like I noted above</p><p>Two run <code>apt-get update</code></p><p>Then run <code>apt-get install jp2a</code></p><p>Then make a folder called /worker/builds/</p><p>And in there follow these instructions <a href=http://jurjenbokma.com/ApprenticesNotes/getting_statlinked_binaries_on_debian.html>http://jurjenbokma.com/ApprenticesNotes/getting_statlinked_binaries_on_debian.html</a> replacing jp2a as needed.</p><p>Then make a folder called /worker/bin and copy jp2a from <code>/worker/builds/jp2a-1.0.6/src/jp2a</code> to this bin folder.</p><p>You should be able to see that run now by ding /worker/bin/jp2a even run <code>apt-get remove jp2a</code> to show it works as a standalone library [3]</p><p>Let&rsquo;s adjust our code</p><pre><code>&lt;?php
/**
 * Created by PhpStorm.
 * User: alfrednutile
 * Date: 4/27/15
 * Time: 9:02 PM
 */

namespace App;


use Illuminate\Support\Facades\File;

class ExampleTwoHandler {


    protected $search_word;
    protected $result;

    public function handle($payload)
    {
        $this-&gt;search_word = $payload['search_word'];
        $this-&gt;getImage();
        return $this-&gt;popFirstResult();
    }

    protected function getImage()
    {
        $url = 'http://ajax.googleapis.com/ajax/services/search/images?v=1.0&amp;q=';
        $url .= urlencode(&quot;site:www.thebrickfan.com &quot; . $this-&gt;search_word . &quot; lego&quot;);
        $curl = curl_init();
        curl_setopt($curl, CURLOPT_URL, $url);
        curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
        $data = curl_exec($curl);
        curl_close($curl);
        $result = json_decode($data, true);
        $this-&gt;result = $result;
    }

    protected function popFirstResult()
    {
        $max = count($this-&gt;result['responseData']['results']);
        if($max == 0)
        {
            throw new \Exception(sprintf(&quot;No image found :( for %s&quot;, $this-&gt;search_word));
        }
        else
        {
            $image = $this-&gt;result['responseData']['results'][rand(0, $max - 1)]['url'];
            $path_to_worker = base_path('bin/');
            exec(&quot;chmod +x {$path_to_worker}/jp2a&quot;);
            exec(&quot;TERM=xterm {$path_to_worker}/bin/jp2a $image&quot;, $output);
            return implode(&quot;\n&quot;, $output);
        }
    }

}
</code></pre><p>run locally and you might get some decent output or not :(</p><p><img src="https://dl.dropboxusercontent.com/s/76vbdf0iubehf5c/worker_batman.png?dl=0" alt=batman></p><h3 id=make-and-upload-the-worker>Make and upload the worker</h3><p>Then I run <code>sh ./make_worker_two.php</code></p><pre><code>touch ExampleTwoWorker.zip
rm ExampleTwoWorker.zip
zip -r ExampleTwoWorker.zip . -x *.git*
iron worker upload --stack php-5.6 ExampleTwoWorker.zip php workers/ExampleTwoWorker.php
</code></pre><p>And run and wait</p><pre><code>iron worker queue --wait -payload-file payload2.json ExampleTwoWorker
</code></pre><p>And if all goes well your console and the logs should show something like</p><p><img src="https://dl.dropboxusercontent.com/s/263tlw5vkswqqvp/worker_results.png?dl=0" alt=batman></p><h2 id=entering-your-docker-environment>Entering your docker environment</h2><p>Easy</p><pre><code>docker run -it -v &quot;$(pwd)&quot;:/worker -w /worker iron/images:php-5.6 /bin/bash
</code></pre><p>Now you can test things in there, download packages etc.</p><h2 id=mvc>MVC</h2><p>Not sure if this really is correct but I tend to see the Worker file as my route file. The handler as the controller and other classes as needed, Service, Repository etc. This makes things more testable etc and better organize imo.</p><h2 id=connecting-the-queue-to-the-worker>Connecting the Queue to the Worker</h2><p>Coming soon&mldr;</p><h2 id=numerous-environments>Numerous Environments</h2><p>Waiting on bug report <a href=https://github.com/iron-io/docs/issues/467>https://github.com/iron-io/docs/issues/467</a></p><p>But part of the process is to setup other projects at iron. For example if my worker is ExampleWorker then I would make ExampleWorker-dev.
I would then switch to my git branch dev and do my changes. Once that is done I would make sure the token and key in my iron.json file matches that new project I made for dev and that is it.</p><p>The other way is slicker cause you do not need to change your iron.json each time but in the mean time this works fine.</p><h2 id=deploy-from-codeship>Deploy from Codeship</h2><p>Codeship will allow you to set custom deploy scripts or bash shells scrips basically.</p><p>In here I placed for the branch I wanted</p><pre><code>curl -sSL -O https://github.com/iron-io/ironcli/releases/download/v0.0.6/ironcli_linux
chmod +x ironcli_linux
touch iron.json
echo &quot;{&quot; &gt;&gt; iron.json
echo '&quot;token&quot;: &quot;bar&quot;,' &gt;&gt; iron.json
echo '&quot;project_id&quot;: &quot;foo&quot;' &gt;&gt; iron.json
echo &quot;}&quot; &gt;&gt; iron.json
zip -r PDF2PagesWorker.zip .
./ironcli_linux worker upload --stack php-5.6 PDF2PagesWorker.zip php workers/PDF2PagesWorker.php
</code></pre><p>You can easily then swap out the related project id and token for the environment you are uploading to eg development, staging etc.</p><h2 id=repo>Repo</h2><p><a href=https://github.com/alnutile/lumen_worker>https://github.com/alnutile/lumen_worker</a></p><p>another example <a href=https://github.com/alnutile/thumbnail-maker>Thumbnail Maker</a></p><p>[1] These seems to be a part of the iron worker for version 1 but not sure why not for 2 maybe there is a better pattern for this.</p><p>[2] I renamed it to ExampleOneLumen</p><p>[3] So far this is a 50/50 solution it did not work for pdf2svg but it did work for pdftk</p></div><div class="tags pl-3" id=tags-single><strong>Tags:</strong>
<a href=/tags/laravel>laravel</a>,
<a href=/tags/php>php</a>,
<a href=/tags/iron>iron</a>,
<a href=/tags/lumen>lumen</a></div><div class=btn-improve-page><a href=https://github.com/alnutile/alnutile.github.io/edit/master/content/posts/143.md><i class="fas fa-code-branch"></i>Improve this page</a></div><hr><div class="row next-prev-navigator"><div class="col-md-6 previous-article"><a href=/posts/144/ class="btn btn-outline-info"><span><i class="fas fa-chevron-circle-left"></i>Prev</span><br><span>Adding Cache to your Laravel Site</span></a></div><div class="col-md-6 next-article"><a href=/posts/142/ class="btn btn-outline-info"><span>Next <i class="fas fa-chevron-circle-right"></i></span><br><span>Quick way to mock data for Behat in Laravel</span></a></div></div><hr><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var dsq=document.createElement("script");dsq.type="text/javascript";dsq.async=true;var disqus_shortname="alfrednutile";dsq.src="//"+disqus_shortname+".disqus.com/embed.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#what-and-why>What and why</a></li><li><a href=#topics-covered>Topics covered</a></li><li><a href=#install-lumen>Install Lumen</a></li><li><a href=#install-iron-client>Install iron client</a></li><li><a href=#install-docker>Install docker</a></li><li><a href=#environment-settings>Environment settings</a></li><li><a href=#the-worker>The worker</a></li><li><a href=#round-1-exampleonehandler>Round 1 ExampleOneHandler</a><ul><li><a href=#uploading-to-iron>Uploading to Iron</a><ul><li><a href=#bundle>Bundle</a></li><li><a href=#looking-at-the-hud-iron-webui>Looking at the HUD (Iron WebUI)</a></li></ul></li></ul></li><li><a href=#round-2-lets-do-something-real>Round 2 Lets do something real</a><ul><li><a href=#making-a-custom-binary>Making a custom binary</a></li><li><a href=#make-and-upload-the-worker>Make and upload the worker</a></li></ul></li><li><a href=#entering-your-docker-environment>Entering your docker environment</a></li><li><a href=#mvc>MVC</a></li><li><a href=#connecting-the-queue-to-the-worker>Connecting the Queue to the Worker</a></li><li><a href=#numerous-environments>Numerous Environments</a></li><li><a href=#deploy-from-codeship>Deploy from Codeship</a></li><li><a href=#repo>Repo</a></li></ul></nav></div></div></section></div><footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=#about>About</a></li><li class=nav-item><a class=smooth-scroll href=#projects>Projects</a></li><li class=nav-item><a class=smooth-scroll href=#recent-posts>Recent Posts</a></li><li class=nav-item><a class=smooth-scroll href=#achievements>Achievements</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><span>Email:</span> <span>me@alfrednutile.info</span></li><li><span>Phone:</span> <span>+1.413.230.4767</span></li></ul></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-2><a id=theme href=https://github.com/hossainemruz/toha target=#><img src=/assets/images/inverted-logo.png>
Toha</a></div><div class="col-md-2 text-center"><a id=theme href=https://icons8.com/ target=_blank><img src=/images/site/icon8.png>
ICONS8</a></div><div class="col-md-8 text-right"><a id=hugo href=https://gohugo.io/>Powered by
<img src=/assets/images/hugo-logo-wide.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/assets/js/jquery-3.4.1.min.js></script><script src=/assets/js/popper.min.js></script><script src=/assets/js/bootstrap.min.js></script><script src=/assets/js/navbar.js></script><script src=/assets/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script><script src=/assets/js/single.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>